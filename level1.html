<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dalgona Circle Challenge</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial Black', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
        }
        
        .main-menu {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 20px;
            min-height: 100vh;
        }
        
        .menu-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .menu-title {
            font-size: 3.5rem;
            color: #fff;
            text-shadow: 5px 5px 0px rgba(255, 0, 122, 0.5);
            margin-bottom: 10px;
        }
        
        .menu-subtitle {
            font-size: 1.5rem;
            color: #f39c12;
        }
        
        .doors-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            max-width: 1400px;
            width: 100%;
        }
        
        .door {
            background: linear-gradient(145deg, #2d3436, #1e272e);
            border-radius: 20px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.4s ease;
            border: 3px solid #34495e;
        }
        
        .door:hover {
            transform: translateY(-10px) scale(1.05);
            border-color: #f39c12;
            box-shadow: 0 20px 40px rgba(243, 156, 18, 0.4);
        }
        
        .door-number {
            width: 40px;
            height: 40px;
            background: #f39c12;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            margin-bottom: 15px;
        }
        
        .door-canvas {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            background: #f5e6d3;
            margin-bottom: 15px;
            border: 3px solid #d4a574;
        }
        
        .door-title {
            font-size: 1.3rem;
            color: #fff;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .door-description {
            font-size: 0.9rem;
            color: #bdc3c7;
            text-align: center;
        }
        
        .game-screen {
            display: none;
            padding: 20px;
            min-height: 100vh;
        }
        
        .game-screen.active {
            display: block;
        }
        
        .game-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            max-width: 900px;
            margin: 0 auto;
        }
        
        .game-header {
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 3px solid #000;
            padding-bottom: 15px;
        }
        
        .game-title {
            font-size: 2.5rem;
            color: #000;
            text-shadow: 3px 3px 0px rgba(243, 156, 18, 0.5);
        }
        
        .game-instructions {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 5px solid #f39c12;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            gap: 15px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            text-align: center;
            min-width: 150px;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .game-area {
            background: #f5e6d3;
            border: 5px solid #d4a574;
            border-radius: 15px;
            padding: 20px;
        }
        
        .game-canvas {
            display: block;
            margin: 0 auto;
            border: 3px dashed #a67c52;
            border-radius: 10px;
            background: white;
            cursor: crosshair;
            touch-action: none;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        
        .btn-start {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }
        
        .btn-back {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            margin-top: 10px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #11998e 0%, #38ef7d 100%);
            transition: width 0.3s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            max-width: 500px;
        }
        
        .modal-title {
            font-size: 3rem;
            margin-bottom: 20px;
        }
        
        .modal-message {
            font-size: 1.5rem;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .difficulty-indicator {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 5px;
        }
        
        .difficulty-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #bdc3c7;
        }
        
        .difficulty-dot.active {
            background: #f39c12;
        }
        
        @media (max-width: 768px) {
            .menu-title {
                font-size: 2.5rem;
            }
            
            .doors-container {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 20px;
            }
            
            .stats {
                flex-direction: column;
                align-items: center;
            }
            
            .game-canvas {
                width: 100%;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <button class="btn btn-start" id="nextLevelBtn" onclick="window.location.href='quiz.html'">Uji Pemahaman ‚û°Ô∏è</button>

    <div class="main-menu" id="mainMenu">
        <div class="menu-header">
            <h1 class="menu-title">üç™ DALGONA CHALLENGE</h1>
            <p class="menu-subtitle">Pilih Pintu Topik Bulatan</p>
        </div>
        
        <div class="doors-container" id="doorsContainer"></div>
    </div>
    
    <div class="game-screen" id="gameScreen">
        <div class="game-container">
            <div class="game-header">
                <h1 class="game-title" id="gameTitle">üç™ DALGONA</h1>
            </div>
            
            <div class="game-instructions" id="gameInstructions">
                <p>Ikut urutan titik yang ditunjukkan. Pastikan anda menyentuh setiap titik mengikut urutan yang betul!</p>
            </div>
            
            <div class="stats">
                <div class="stat-box">
                    <div>‚è±Ô∏è Masa</div>
                    <div class="stat-value" id="timer">60</div>
                </div>
                <div class="stat-box">
                    <div>üéØ Ketepatan</div>
                    <div class="stat-value" id="accuracy">0%</div>
                </div>
                <div class="stat-box">
                    <div>‚≠ê Markah</div>
                    <div class="stat-value" id="score">0</div>
                </div>
            </div>
            
            <div class="game-area">
                <canvas class="game-canvas" id="gameCanvas" width="600" height="600"></canvas>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress"></div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn btn-back" id="backBtn">‚Üê Kembali</button>
                <button class="btn btn-start" id="startBtn">Mula</button>
                <button class="btn btn-reset" id="resetBtn">Reset</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="resultModal">
        <div class="modal-content">
            <div class="modal-title" id="resultEmoji">üéâ</div>
            <div class="modal-message" id="resultMessage">Bagus!</div>
            <div class="modal-message" id="resultStats"></div>
            <button class="btn btn-start" id="playAgainBtn">Main Lagi</button>
            <button class="btn btn-back" id="backMenuBtn">Kembali</button>
        </div>
    </div>
    
    <script>
        const doors = [
            { 
                id: 1, 
                title: 'Lilitan', 
                desc: 'Ikut garis lilitan', 
                type: 'circle', 
                dots: 16, 
                time: 45,
                difficulty: 2,
                instructions: 'Ikut garis lilitan bulatan dengan menyentuh semua titik mengikut urutan.'
            },
            { 
                id: 2, 
                title: 'Pusat Bulatan', 
                desc: 'Tanda pusat bulatan', 
                type: 'center', 
                dots: 1, 
                time: 20,
                difficulty: 1,
                instructions: 'Sentuh pusat bulatan.'
            },
            { 
                id: 3, 
                title: 'Diameter', 
                desc: 'Garis melalui pusat', 
                type: 'diameter', 
                dots: 8, 
                time: 30,
                difficulty: 2,
                instructions: 'Ikut garis diameter dari satu hujung ke hujung yang lain.'
            },
            { 
                id: 4, 
                title: 'Sektor', 
                desc: 'Sektor bulatan', 
                type: 'sector', 
                dots: 10, 
                time: 40,
                difficulty: 3,
                instructions: 'Ikut sempadan sektor bulatan.'
            },
            { 
                id: 5, 
                title: 'Tembereng', 
                desc: 'Garisan tidak melalui pusat', 
                type: 'segment', 
                dots: 8, 
                time: 35,
                difficulty: 2,
                instructions: 'Ikut garis tembereng (garis lurus yang tidak melalui pusat).'
            },
            { 
                id: 6, 
                title: 'Perentas', 
                desc: 'Garis perentas panjang', 
                type: 'chord', 
                dots: 8, 
                time: 35,
                difficulty: 2,
                instructions: 'Ikut garis perentas (garis lurus yang menghubungkan dua titik pada lilitan).'
            },
            { 
                id: 7, 
                title: 'Lengkok', 
                desc: 'Lengkok bulatan', 
                type: 'arc', 
                dots: 10, 
                time: 35,
                difficulty: 3,
                instructions: 'Ikut lengkok bulatan dari satu titik ke titik yang lain.'
            },
            { 
                id: 8, 
                title: 'Jejari', 
                desc: 'Jejari dari pusat', 
                type: 'radius', 
                dots: 6, 
                time: 25,
                difficulty: 2,
                instructions: 'Ikut jejari dari pusat ke lilitan bulatan.'
            }
        ];
        
        let currentDoor = null;
        let gameState = {
            isPlaying: false,
            timeLeft: 60,
            score: 0,
            accuracy: 0,
            path: [],
            dots: [],
            completedDots: 0,
            nextDotIndex: 0,
            timer: null,
            isDrawing: false,
            startTime: 0,
            totalTime: 0
        };
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = 200;
        const tolerance = 25;
        
        function createDoors() {
            const container = document.getElementById('doorsContainer');
            doors.forEach(door => {
                const doorDiv = document.createElement('div');
                doorDiv.className = 'door';
                doorDiv.onclick = () => openDoor(door);
                
                // Create difficulty indicator
                let difficultyDots = '';
                for (let i = 0; i < 3; i++) {
                    difficultyDots += `<div class="difficulty-dot ${i < door.difficulty ? 'active' : ''}"></div>`;
                }
                
                doorDiv.innerHTML = `
                    <div class="door-number">${door.id}</div>
                    <canvas class="door-canvas" id="canvas${door.id}" width="250" height="200"></canvas>
                    <h3 class="door-title">${door.title}</h3>
                    <p class="door-description">${door.desc}</p>
                    <div class="difficulty-indicator">
                        ${difficultyDots}
                    </div>
                `;
                container.appendChild(doorDiv);
            });
            drawDoorPreviews();
        }
        
        function drawDoorPreviews() {
            doors.forEach(door => {
                const canvas = document.getElementById(`canvas${door.id}`);
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                const cx = canvas.width / 2;
                const cy = canvas.height / 2;
                const r = 70;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.strokeStyle = '#2c3e50';
                ctx.lineWidth = 3;
                ctx.fillStyle = 'rgba(243, 156, 18, 0.2)';
                
                if (door.type === 'circle') {
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.stroke();
                } else if (door.type === 'center') {
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.stroke();
                    // Draw crosshair at center
                    ctx.beginPath();
                    ctx.moveTo(cx - 15, cy);
                    ctx.lineTo(cx + 15, cy);
                    ctx.moveTo(cx, cy - 15);
                    ctx.lineTo(cx, cy + 15);
                    ctx.strokeStyle = '#e74c3c';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                    // Draw center dot
                    ctx.beginPath();
                    ctx.arc(cx, cy, 8, 0, Math.PI * 2);
                    ctx.fillStyle = '#e74c3c';
                    ctx.fill();
                } else if (door.type === 'diameter') {
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.moveTo(cx - r, cy);
                    ctx.lineTo(cx + r, cy);
                    ctx.strokeStyle = '#e74c3c';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                } else if (door.type === 'sector') {
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.arc(cx, cy, r, 0, Math.PI / 2);
                    ctx.lineTo(cx, cy);
                    ctx.fill();
                    ctx.stroke();
                } else if (door.type === 'segment') {
                    // Draw circle
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.stroke();
                    // Draw chord (tembereng) - horizontal line NOT through center
                    const offsetY = cy - r * 0.4; // Above center
                    ctx.beginPath();
                    ctx.moveTo(cx - r * 0.7, offsetY);
                    ctx.lineTo(cx + r * 0.7, offsetY);
                    ctx.strokeStyle = '#9b59b6';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                } else if (door.type === 'chord') {
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.stroke();
                    // Draw diagonal chord (perentas)
                    ctx.moveTo(cx - r * 0.7, cy - r * 0.5);
                    ctx.lineTo(cx + r * 0.7, cy + r * 0.5);
                    ctx.strokeStyle = '#27ae60';
                    ctx.lineWidth = 4;
                    ctx.stroke();
                } else if (door.type === 'arc') {
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, Math.PI/6, Math.PI * 5/6);
                    ctx.strokeStyle = '#9b59b6';
                    ctx.lineWidth = 5;
                    ctx.stroke();
                } else if (door.type === 'radius') {
                    ctx.beginPath();
                    ctx.arc(cx, cy, r, 0, Math.PI * 2);
                    ctx.stroke();
                    for (let a = 0; a < Math.PI * 2; a += Math.PI / 4) {
                        ctx.beginPath();
                        ctx.moveTo(cx, cy);
                        ctx.lineTo(cx + Math.cos(a) * r, cy + Math.sin(a) * r);
                        ctx.strokeStyle = '#e74c3c';
                        ctx.lineWidth = 3;
                        ctx.stroke();
                    }
                }
                
                ctx.beginPath();
                ctx.arc(cx, cy, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#2c3e50';
                ctx.fill();
            });
        }
        
        function openDoor(door) {
            currentDoor = door;
            document.getElementById('gameTitle').textContent = `üç™ ${door.title}`;
            document.getElementById('gameInstructions').innerHTML = `<p>${door.instructions}</p>`;
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('gameScreen').classList.add('active');
            initGame();
        }
        
        function initGame() {
            gameState.dots = [];
            gameState.completedDots = 0;
            gameState.timeLeft = currentDoor.time;
            document.getElementById('timer').textContent = currentDoor.time;
            
            const type = currentDoor.type;
            const count = currentDoor.dots;
            
            if (type === 'circle') {
                for (let i = 0; i < count; i++) {
                    const angle = (i / count) * Math.PI * 2 - Math.PI / 2;
                    gameState.dots.push({
                        x: centerX + Math.cos(angle) * radius,
                        y: centerY + Math.sin(angle) * radius,
                        completed: false
                    });
                }
            } else if (type === 'center') {
                // Just one dot at the center
                gameState.dots.push({
                    x: centerX,
                    y: centerY,
                    completed: false
                });
            } else if (type === 'diameter') {
                for (let i = 0; i < count; i++) {
                    const t = i / (count - 1);
                    gameState.dots.push({
                        x: centerX - radius + (2 * radius * t),
                        y: centerY,
                        completed: false
                    });
                }
            } else if (type === 'sector') {
                const startAngle = 0;
                const endAngle = Math.PI / 2;
                
                // Add points along the arc
                for (let i = 0; i < count / 2; i++) {
                    const angle = startAngle + (i / (count / 2 - 1)) * (endAngle - startAngle);
                    gameState.dots.push({
                        x: centerX + Math.cos(angle) * radius,
                        y: centerY + Math.sin(angle) * radius,
                        completed: false
                    });
                }
                
                // Add points along the radius back to center
                for (let i = count / 2; i < count; i++) {
                    const t = (i - count / 2) / (count / 2 - 1);
                    const x = centerX + (1 - t) * Math.cos(endAngle) * radius;
                    const y = centerY + (1 - t) * Math.sin(endAngle) * radius;
                    gameState.dots.push({
                        x: x,
                        y: y,
                        completed: false
                    });
                }
            } else if (type === 'segment') {
                // Tembereng - horizontal line above center (NOT through center)
                const offsetY = centerY - radius * 0.4;
                const halfWidth = radius * 0.7;
                
                for (let i = 0; i < count; i++) {
                    const t = i / (count - 1);
                    gameState.dots.push({
                        x: centerX - halfWidth + (2 * halfWidth * t),
                        y: offsetY,
                        completed: false
                    });
                }
            } else if (type === 'chord') {
                for (let i = 0; i < count; i++) {
                    const t = i / (count - 1);
                    gameState.dots.push({
                        x: centerX - radius * 0.7 + (1.4 * radius * t),
                        y: centerY - radius * 0.5 + (radius * t),
                        completed: false
                    });
                }
            } else if (type === 'arc') {
                const start = Math.PI / 6;
                const end = Math.PI * 5 / 6;
                for (let i = 0; i < count; i++) {
                    const a = start + (i / (count - 1)) * (end - start);
                    gameState.dots.push({
                        x: centerX + Math.cos(a) * radius,
                        y: centerY + Math.sin(a) * radius,
                        completed: false
                    });
                }
            } else if (type === 'radius') {
                for (let i = 0; i < count; i++) {
                    const a = (i / count) * Math.PI * 2;
                    gameState.dots.push({
                        x: centerX + Math.cos(a) * radius,
                        y: centerY + Math.sin(a) * radius,
                        completed: false
                    });
                }
            }
            
            drawGame();
        }
        
        function drawGame() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw tolerance area
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius + tolerance, 0, Math.PI * 2);
            ctx.fillStyle = 'rgba(255, 235, 59, 0.2)';
            ctx.fill();
            
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius - tolerance, 0, Math.PI * 2);
            ctx.fillStyle = 'white';
            ctx.fill();
            
            // Draw the main circle
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.strokeStyle = '#2c3e50';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Draw dots
            gameState.dots.forEach((dot, i) => {
                ctx.beginPath();
                ctx.arc(dot.x, dot.y, dot.completed ? 8 : 6, 0, Math.PI * 2);
                ctx.fillStyle = dot.completed ? '#27ae60' : (i === gameState.nextDotIndex ? '#f39c12' : '#e74c3c');
                ctx.fill();
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                if (!dot.completed) {
                    ctx.fillStyle = i === gameState.nextDotIndex ? 'white' : '#2c3e50';
                    ctx.font = 'bold 12px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(i + 1, dot.x, dot.y);
                }
                
                // Highlight next dot
                if (i === gameState.nextDotIndex && gameState.isPlaying) {
                    ctx.beginPath();
                    ctx.arc(dot.x, dot.y, 15, 0, Math.PI * 2);
                    ctx.strokeStyle = '#f39c12';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([5, 5]);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            });
            
            // Draw path
            if (gameState.path.length > 1) {
                ctx.beginPath();
                ctx.moveTo(gameState.path[0].x, gameState.path[0].y);
                for (let i = 1; i < gameState.path.length; i++) {
                    ctx.lineTo(gameState.path[i].x, gameState.path[i].y);
                }
                ctx.strokeStyle = '#3498db';
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';
                ctx.stroke();
            }
            
            // Draw center point
            ctx.beginPath();
            ctx.arc(centerX, centerY, 5, 0, Math.PI * 2);
            ctx.fillStyle = '#2c3e50';
            ctx.fill();
        }
        
        function startGame() {
            gameState.isPlaying = true;
            gameState.score = 0;
            gameState.accuracy = 0;
            gameState.path = [];
            gameState.completedDots = 0;
            gameState.nextDotIndex = 0;
            gameState.startTime = Date.now();
            gameState.dots.forEach(d => d.completed = false);
            
            document.getElementById('startBtn').disabled = true;
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;
                if (gameState.timeLeft <= 0) {
                    endGame(false, 'GAGAL!', 'Masa tamat sebelum siap');
                }
            }, 1000);
        }
        
        function checkPoint(x, y) {
            // Check if touching wrong dot (not the next one in sequence)
            gameState.dots.forEach((dot, index) => {
                if (dot.completed) return; // Skip already completed dots
                
                const dist = Math.sqrt((x - dot.x) ** 2 + (y - dot.y) ** 2);
                
                if (dist < 20) {
                    // If this is the correct next dot
                    if (index === gameState.nextDotIndex) {
                        dot.completed = true;
                        gameState.completedDots++;
                        gameState.nextDotIndex++;
                        gameState.score += 10;
                        updateStats();
                    } else {
                        // Wrong dot touched - GAME OVER!
                        endGame(false, 'SALAH URUTAN!', 'Anda kena dot nombor ' + (index + 1) + ' tetapi sepatutnya dot ' + (gameState.nextDotIndex + 1));
                    }
                }
            });
        }
        
        function updateStats() {
            gameState.accuracy = Math.round((gameState.completedDots / gameState.dots.length) * 100);
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('accuracy').textContent = gameState.accuracy + '%';
            document.getElementById('progress').style.width = gameState.accuracy + '%';
            
            if (gameState.completedDots === gameState.dots.length) {
                gameState.totalTime = (Date.now() - gameState.startTime) / 1000;
                endGame(true, 'BERJAYA!');
            }
        }
        
        function endGame(success, title, extraMessage) {
            clearInterval(gameState.timer);
            gameState.isPlaying = false;
            document.getElementById('startBtn').disabled = false;
            
            const modal = document.getElementById('resultModal');
            const emoji = document.getElementById('resultEmoji');
            const msg = document.getElementById('resultMessage');
            const stats = document.getElementById('resultStats');
            
            if (success) {
                const bonus = Math.max(0, gameState.timeLeft * 5);
                gameState.score += bonus;
                emoji.textContent = 'üéâ';
                msg.textContent = title || 'BERJAYA!';
                stats.innerHTML = `Markah: ${gameState.score}<br>Ketepatan: ${gameState.accuracy}%<br>Bonus: +${bonus}<br>Masa: ${gameState.totalTime.toFixed(1)}s`;
            } else {
                emoji.textContent = '‚ùå';
                msg.textContent = title || 'GAGAL!';
                let statsText = `Markah: ${gameState.score}<br>Ketepatan: ${gameState.accuracy}%`;
                if (extraMessage) {
                    statsText += `<br><br>${extraMessage}`;
                }
                statsText += '<br><br>Cuba lagi!';
                stats.innerHTML = statsText;
            }
            
            modal.classList.add('active');
        }
        
        function resetGame() {
            clearInterval(gameState.timer);
            gameState.isPlaying = false;
            gameState.path = [];
            gameState.nextDotIndex = 0;
            document.getElementById('startBtn').disabled = false;
            initGame();
        }
        
        // Event listeners for mouse and touch
        canvas.addEventListener('mousedown', (e) => {
            if (!gameState.isPlaying) return;
            gameState.isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            gameState.path = [{ x: e.clientX - rect.left, y: e.clientY - rect.top }];
        });
        
        canvas.addEventListener('mousemove', (e) => {
            if (!gameState.isPlaying || !gameState.isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            gameState.path.push({ x, y });
            checkPoint(x, y);
            drawGame();
        });
        
        canvas.addEventListener('mouseup', () => {
            gameState.isDrawing = false;
        });
        
        canvas.addEventListener('touchstart', (e) => {
            if (!gameState.isPlaying) return;
            e.preventDefault();
            gameState.isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            gameState.path = [{ x: touch.clientX - rect.left, y: touch.clientY - rect.top }];
        });
        
        canvas.addEventListener('touchmove', (e) => {
            if (!gameState.isPlaying || !gameState.isDrawing) return;
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0];
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            gameState.path.push({ x, y });
            checkPoint(x, y);
            drawGame();
        });
        
        canvas.addEventListener('touchend', () => {
            gameState.isDrawing = false;
        });
        
        // Button event listeners
        document.getElementById('backBtn').onclick = () => {
            resetGame();
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('mainMenu').style.display = 'flex';
        };
        
        document.getElementById('startBtn').onclick = startGame;
        document.getElementById('resetBtn').onclick = resetGame;
        
        document.getElementById('playAgainBtn').onclick = () => {
            document.getElementById('resultModal').classList.remove('active');
            resetGame();
        };
        
        document.getElementById('backMenuBtn').onclick = () => {
            document.getElementById('resultModal').classList.remove('active');
            document.getElementById('gameScreen').classList.remove('active');
            document.getElementById('mainMenu').style.display = 'flex';
        };
        
        // Initialize the game
        createDoors();
    </script>
</body>
</html>